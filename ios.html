<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <title>ë‚´ í•˜ë£¨ ê¸°ë¡ Â· iPhone v3+</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#1d2433; --muted:#6c778a; --accent:#2563eb; --accent-soft:#e6efff; --danger:#e11d48; --border:#e7e9ef; --shadow:0 6px 20px rgba(28,34,46,.08); --pill:#f1f4f9;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;line-height:1.38}
    header{position:sticky;top:0;z-index:100;background:rgba(246,247,251,.9);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:880px;margin:0 auto;padding:12px 16px}
    h1{font-size:20px;margin:6px 0 10px 0;letter-spacing:.2px}
    .tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .tab-btn{padding:10px 12px;text-align:center;border-radius:12px;background:var(--card);border:1px solid var(--border);color:var(--muted);font-weight:700;box-shadow:var(--shadow);cursor:pointer}
    .tab-btn.active{color:var(--text);border-color:var(--accent);box-shadow:0 0 0 1.5px var(--accent) inset, var(--shadow)}
    main{padding:12px 16px}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;margin:12px 0;box-shadow:var(--shadow)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);font-size:16px}
    input[type="checkbox"]{width:auto;height:auto}
    textarea{min-height:88px;resize:vertical}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:800;cursor:pointer}
    button.secondary{background:#fff;color:var(--text);cursor:pointer}
    button.danger{background:var(--danger);border-color:var(--danger);color:#fff;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .help{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
    th{text-align:left;color:var(--muted);font-weight:700}
    tr:hover td{background:#fafbff}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12.5px;background:var(--pill);color:#3b4453;margin:2px 4px 0 0}
    .right{text-align:right}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
    .flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .banner{border-left:3px solid var(--accent);padding:10px 12px;background:var(--accent-soft);border-radius:10px}
    .actbar{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin:6px 0 10px}
    .actbtn{padding:12px 10px;border:1px solid var(--border);border-radius:12px;background:#fff;text-align:center;font-weight:800;box-shadow:var(--shadow);cursor:pointer;user-select:none}
    .actbtn.active{border-color:var(--accent);box-shadow:0 0 0 1.5px var(--accent) inset,var(--shadow)}
    .rating-seg{display:flex;gap:6px;flex-wrap:wrap}
    .rating-seg .seg{width:calc((100% - 9*6px)/10);min-width:28px;text-align:center;padding:10px 0;border:1px solid var(--border);border-radius:10px;cursor:pointer;user-select:none;color:#525f76;background:#fff;font-weight:700}
    .rating-seg .seg.active{border-color:var(--accent);color:#0f1a2e;box-shadow:0 0 0 1.5px var(--accent) inset}
    .slider-wrap{padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow)}
    .tlabel{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;color:#3b4453;font-weight:700}
    input[type="range"]{width:100%;margin:6px 0;height:28px;-webkit-appearance:none;background:transparent}
    input[type="range"]::-webkit-slider-runnable-track{height:6px;background:linear-gradient(90deg,#dfe7ff,#eef2ff);border-radius:999px}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;margin-top:-10px;width:28px;height:28px;border-radius:50%;background:#fff;border:2px solid var(--accent);box-shadow:var(--shadow)}
    .snack{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:12px 14px;border-radius:12px;display:none;gap:10px;align-items:center;z-index:300;box-shadow:var(--shadow)}
    .snack.show{display:flex}
    .snack a{color:#a7f3d0;font-weight:800;text-decoration:underline}
    /* exercise builder */
    .setrow{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;align-items:center}
    .setlist{border:1px solid var(--border);border-radius:12px;padding:8px}
    .setbadge{font-variant-numeric:tabular-nums}
    @media (max-width:560px){.grid-2,.row{grid-template-columns:1fr}.grid-3{grid-template-columns:1fr}.tabs{grid-template-columns:1fr 1fr 1fr}.actbar{grid-template-columns:repeat(6,1fr)}.setrow{grid-template-columns:1.4fr 1fr 1fr 1fr auto}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ğŸ“’ ë‚´ í•˜ë£¨ ê¸°ë¡ (iPhone Â· v3+)</h1>
      <div class="tabs">
        <div class="tab-btn active" data-tab="log">ê¸°ë¡í•˜ê¸°</div>
        <div class="tab-btn" data-tab="history">íˆìŠ¤í† ë¦¬</div>
        <div class="tab-btn" data-tab="export">ë‚´ë³´ë‚´ê¸°</div>
      </div>
    </div>
  </header>
  <main class="wrap">
    <!-- ê¸°ë¡í•˜ê¸° -->
    <section class="card tab-content" data-section="log" id="tab-log">
      <label>í™œë™</label>
      <div class="actbar" id="actbar">
        <div class="actbtn active" data-act="study">ê³µë¶€</div>
        <div class="actbtn" data-act="exercise">ìš´ë™</div>
        <div class="actbtn" data-act="meal">ë°¥</div>
        <div class="actbtn" data-act="rest">íœ´ì‹</div>
        <div class="actbtn" data-act="sleep">ìˆ˜ë©´</div>
        <div class="actbtn" data-act="memo">ë©”ëª¨</div>
      </div>

      <!-- ì¼ë°˜ í™œë™ìš© ë‚ ì§œ -->
      <div id="normal_date_row" class="grid-2">
        <div>
          <label>ë‚ ì§œ</label>
          <input type="date" id="date">
        </div>
        <div>
          <label>ì„¸ë¶€ìœ í˜•(ì„ íƒ)</label>
          <input type="text" id="sub_type" placeholder="ë¬¸í’€/ë²¤ì¹˜/ì ì‹¬/ë‚®ì  ë“±">
        </div>
      </div>
      
      <!-- ìˆ˜ë©´ìš© ë‚ ì§œ -->
      <div id="sleep_date_row" class="grid-2" style="display:none;">
        <div>
          <label>ìˆ˜ë©´ ì‹œì‘ì¼</label>
          <input type="date" id="sleep_start_date">
        </div>
        <div>
          <label>ìˆ˜ë©´ ì¢…ë£Œì¼</label>
          <input type="date" id="sleep_end_date">
        </div>
      </div>
      
      <div id="sleep_subtype_row" class="grid-2" style="display:none;">
        <div>
          <label>ì„¸ë¶€ìœ í˜•(ì„ íƒ)</label>
          <input type="text" id="sleep_sub_type" placeholder="ê¹Šì€ì /ë‚®ì /ë¶ˆë©´ ë“±">
        </div>
        <div></div>
      </div>

      <div id="time_wrap" class="mt12">
        <div class="slider-wrap">
          <div class="tlabel"><span>ì‹œì‘ ì‹œê°</span><span id="start_label">09:00</span></div>
          <input type="range" id="start_slider" min="0" max="1435" step="5" />
        </div>
        <div class="slider-wrap mt12">
          <div class="tlabel"><span>ë ì‹œê°</span><span id="end_label">10:00</span></div>
          <input type="range" id="end_slider" min="0" max="1435" step="5" />
        </div>
      </div>

      <div id="rating_wrap" class="mt12">
        <label><span id="rating_label">ì§‘ì¤‘ë„</span> (1â€“10)</label>
        <input type="hidden" id="rating" value="7">
        <div class="rating-seg" id="rating_seg"></div>
      </div>

      <!-- âœ… ê³µë¶€ ì¶”ê°€ í•„ë“œ -->
      <div id="study_extra" class="grid-2 mt12" style="display:none;">
        <div>
          <label>ì¦‰ì‹œ íšŒìƒë¥ (%)</label>
          <input type="number" id="recall_score_pct" min="0" max="100" step="1" placeholder="ì˜ˆ: 85">
        </div>
        <div>
          <label>ë°©í•´ íšŸìˆ˜</label>
          <input type="number" id="distraction_count" min="0" step="1" placeholder="ì˜ˆ: 0">
        </div>
      </div>

      <!-- âœ… ìˆ˜ë©´ ì¶”ê°€ í•„ë“œ (íŒ¨í„´ êµì •ìš©) -->
      <div id="sleep_extra" class="grid-3 mt12" style="display:none;">
        <div>
          <label>ì…ë©´ ì§€ì—°(ë¶„)</label>
          <input type="number" id="sleep_latency_min" min="0" step="1" placeholder="ì ë“¤ê¸°ê¹Œì§€ ê±¸ë¦° ì‹œê°„">
        </div>
        <div>
          <label>ë§ˆì§€ë§‰ ì¹´í˜ì¸ ì‹œê°</label>
          <input type="time" id="last_caffeine_time">
        </div>
        <div>
          <label>ìŠ¤í¬ë¦° ì˜¤í”„ ì‹œê°</label>
          <input type="time" id="screens_off_time">
        </div>
      </div>

      <div class="grid-3 mt12">
        <div>
          <label>ëª¸ë¬´ê²Œ(kg)</label>
          <input type="number" id="weight" min="0" step="0.1" placeholder="ì„ íƒ">
        </div>
        <div>
          <label>ë™ê¸°ë¶€ì—¬(1â€“10)</label>
          <input type="number" id="motivation" min="1" max="10" step="1" placeholder="ì„ íƒ">
        </div>
        <div>
          <label>ë©”ëª¨(ì„ íƒ)</label>
          <input type="text" id="note" placeholder="ê°„ë‹¨ ë©”ëª¨">
        </div>
      </div>

      <!-- âœ… ì¼ì¼ ì§€í‘œ í€µ ì…ë ¥ (ì•„ì¹¨ì²´ì¤‘/ë‹¨ë°±ì§ˆ/í¬ë ˆì•„í‹´/D-ê°’) -->
      <section class="card mt12" id="daily_quick">
        <div class="grid-3">
          <div>
            <label>ì•„ì¹¨ ì²´ì¤‘(kg)</label>
            <input type="number" id="morning_weight_kg" min="0" step="0.1" placeholder="ê³µë³µ ì²´ì¤‘">
          </div>
          <div>
            <label>ì¼ì¼ ë‹¨ë°±ì§ˆ(g)</label>
            <input type="number" id="protein_g_day" min="0" step="1" placeholder="ì˜ˆ: 160">
          </div>
          <div style="display:flex;align-items:flex-end;gap:10px">
            <div style="flex:1">
              <label>í¬ë ˆì•„í‹´ 5g</label>
              <div class="flex"><input type="checkbox" id="creatine_5g"><span class="help">ë³µìš© ì‹œ ì²´í¬</span></div>
            </div>
          </div>
        </div>
        <div class="grid-2 mt12">
          <div>
            <label>ì‹œí—˜ ì„ë°•ë„ (D-)</label>
            <input type="number" id="days_to_exam" min="0" step="1" placeholder="ì˜ˆ: 21">
          </div>
          <div class="flex" style="align-items:flex-end;justify-content:flex-end">
            <button class="secondary" id="daily_save_btn">ì¼ì¼ ì§€í‘œ ë¹ ë¥¸ ì €ì¥</button>
          </div>
        </div>
        <p class="help mt8">ë‚ ì§œëŠ” ìƒë‹¨ì˜ <b>ë‚ ì§œ</b> ì…ë ¥ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. CSVë¡œ í•¨ê»˜ ë‚´ë³´ë‚´ì§‘ë‹ˆë‹¤.</p>
      </section>

      <!-- âœ… ìš´ë™ ì„¸íŠ¸ ê¸°ë¡ (ê°„ë‹¨ Â· í—¬ìŠ¤ì•± ìŠ¤íƒ€ì¼) -->
      <section class="card mt12" id="ex_builder" style="display:none;">
        <div class="grid-2">
          <div>
            <label>ìš´ë™ëª…</label>
            <input list="movements" id="ex_movement" placeholder="ì˜ˆ: ë²¤ì¹˜í”„ë ˆìŠ¤">
            <datalist id="movements">
              <option>ìŠ¤ì¿¼íŠ¸</option><option>ë²¤ì¹˜í”„ë ˆìŠ¤</option><option>ë°ë“œë¦¬í”„íŠ¸</option><option>ì˜¤ë²„í—¤ë“œí”„ë ˆìŠ¤</option><option>ë°”ë²¨ë¡œìš°</option><option>ë«í’€ë‹¤ìš´</option><option>í’€ì—…</option><option>ë ˆê·¸í”„ë ˆìŠ¤</option>
            </datalist>
          </div>
          <div>
            <label>ë…¸íŠ¸(ì„ íƒ)</label>
            <input type="text" id="ex_note" placeholder="ì˜ˆ: ì¤‘ëŸ‰ ìƒìŠ¹, í¼ ì•ˆì •">
          </div>
        </div>
        <div class="setrow mt12">
          <input type="number" id="ex_weight" placeholder="kg" min="0" step="0.5">
          <input type="number" id="ex_reps" placeholder="reps" min="1" step="1">
          <input type="number" id="ex_rpe" placeholder="RPE" min="1" max="10" step="0.5">
          <button class="secondary" id="add_set_btn">ì„¸íŠ¸ ì¶”ê°€</button>
          <button class="danger" id="clear_sets_btn">ì„¸íŠ¸ ì´ˆê¸°í™”</button>
        </div>
        <div class="setlist mt12" id="set_list"></div>
        <div class="help mt8" id="ex_summary"></div>
      </section>

      <div class="row mt16">
        <button class="primary" id="save_btn">ì €ì¥</button>
        <button class="secondary" id="reset_form_btn">ì…ë ¥ ì´ˆê¸°í™”</button>
      </div>

      <div class="banner mt16 help">
        <b>Tip</b>: í™œë™ ë²„íŠ¼ â†’ ìŠ¬ë¼ì´ë”ë¡œ ì‹œê°„ë§Œ ë“œë˜ê·¸í•´ ì €ì¥í•˜ë©´ ë. ì¼ì¼ ì§€í‘œ ì˜ì—­ì€ <b>ì›í„°ì¹˜</b>ë¡œ ë”°ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </section>

    <!-- íˆìŠ¤í† ë¦¬ -->
    <section class="card tab-content" data-section="history" id="tab-history" style="display:none;">
      <div class="row">
        <div>
          <label>ê²€ìƒ‰(ë©”ëª¨/ìœ í˜•)</label>
          <input type="search" id="search_text" placeholder="í‚¤ì›Œë“œ">
        </div>
        <div>
          <label>í™œë™ í•„í„°</label>
          <select id="filter_activity">
            <option value="">ì „ì²´</option>
            <option value="study">ê³µë¶€</option>
            <option value="exercise">ìš´ë™</option>
            <option value="meal">ë°¥</option>
            <option value="rest">íœ´ì‹</option>
            <option value="sleep">ìˆ˜ë©´</option>
            <option value="memo">ë©”ëª¨</option>
          </select>
        </div>
      </div>
      <div class="row mt12">
        <div>
          <label>ì‹œì‘ì¼</label>
          <input type="date" id="hist_from">
        </div>
        <div>
          <label>ì¢…ë£Œì¼</label>
          <input type="date" id="hist_to">
        </div>
      </div>
      <div class="mt12">
        <table id="history_table">
          <thead>
            <tr>
              <th>ë‚ ì§œ</th>
              <th>ì‹œê°„</th>
              <th>í™œë™</th>
              <th>í‰ì •</th>
              <th>ëª¸ë¬´ê²Œ</th>
              <th>ë™ê¸°</th>
              <th>ì„¸ë¶€</th>
              <th>ë©”ëª¨</th>
              <th class="right">ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="mt12 right">
        <button class="danger" id="clear_all_btn">ì „ì²´ ì‚­ì œ</button>
      </div>
    </section>

    <!-- ë‚´ë³´ë‚´ê¸° -->
    <section class="card tab-content" data-section="export" id="tab-export" style="display:none;">
      <div class="row">
        <div>
          <label>ë‚´ë³´ë‚´ê¸° ì‹œì‘ì¼</label>
          <input type="date" id="export_from">
        </div>
        <div>
          <label>ë‚´ë³´ë‚´ê¸° ì¢…ë£Œì¼</label>
          <input type="date" id="export_to">
        </div>
      </div>

      <div class="flex mt12">
        <span class="pill" data-preset="thisweek">ì´ë²ˆ ì£¼</span>
        <span class="pill" data-preset="lastweek">ì§€ë‚œ ì£¼</span>
        <span class="pill" data-preset="thismonth">ì´ë²ˆ ë‹¬</span>
      </div>

      <div class="mt12">
        <button class="primary" id="export_btn">CSV ë‹¤ìš´ë¡œë“œ</button>
        <p class="help mt8">ì„ íƒí•œ ê¸°ê°„ì˜ í•­ëª©ë§Œ CSVë¡œ ì €ì¥ë©ë‹ˆë‹¤.</p>
      </div>

      <div class="mt16">
        <h3 style="margin:8px 0;">ë°±ì—…/ë³µì›</h3>
        <div class="flex">
          <button class="secondary" id="backup_json_btn">ë°±ì—…(JSON ì €ì¥)</button>
          <label class="pill" for="restore_json_input" style="cursor:pointer;">ë³µì›(JSON ë¶ˆëŸ¬ì˜¤ê¸°)</label>
          <input type="file" id="restore_json_input" accept="application/json" style="display:none;">
        </div>
        <p class="help mt8">ë³µì› ì‹œ ê¸°ì¡´ ë°ì´í„°ì— <b>ë³‘í•©</b>ë©ë‹ˆë‹¤. ì™„ì „ êµì²´ë¥¼ ì›í•˜ë©´ ë³µì› ì „ì— 'ì „ì²´ ì‚­ì œ'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p>
      </div>
    </section>
  </main>

  <div class="snack" id="snack"></div>

<script>
(function(){
  const KEY='mylife_logs_v3';
  const $=sel=>document.querySelector(sel);
  const $$=sel=>Array.from(document.querySelectorAll(sel));

  // helpers
  function todayStr(){const d=new Date();const mm=('0'+(d.getMonth()+1)).slice(-2);const dd=('0'+d.getDate()).slice(-2);return d.getFullYear()+'-'+mm+'-'+dd;}
  function load(){try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){return[]}}
  function save(arr){localStorage.setItem(KEY,JSON.stringify(arr))}
  function ratingLabel(act){return {study:'ì§‘ì¤‘ë„',exercise:'RPE',meal:'í¬ë§Œê°',rest:'íšŒë³µê°',sleep:'ìˆ˜ë©´ì§ˆ',memo:'ë©”ëª¨'}[act]||'í‰ì •'}
  function activityName(act){return {study:'ê³µë¶€',exercise:'ìš´ë™',meal:'ë°¥',rest:'íœ´ì‹',sleep:'ìˆ˜ë©´',memo:'ë©”ëª¨'}[act]||act}
  function toCSV(rows){
    const header=['id','date','start_time','end_time','activity','sub_type','rating_name','rating','weight_kg','motivation','note','duration_min','sleep_end_date','morning_weight_kg','protein_g_day','creatine_5g','last_caffeine_time','screens_off_time','sleep_latency_min','recall_score_pct','distraction_count','days_to_exam','exercise_json'];
    const esc=v=>{if(v==null)return'';const s=String(v).replace(/"/g,'""');return /[",\n]/.test(s)?`"${s}"`:s};
    const out=[header.join(',')]; rows.forEach(r=>out.push(header.map(h=>esc(r[h])).join(','))); return out.join('\n');
  }
  function withinRange(dateStr,fromStr,toStr){if(!fromStr&&!toStr)return true; if(!dateStr)return false; if(fromStr&&dateStr<fromStr)return false; if(toStr&&dateStr>toStr)return false; return true;}
  function durationMin(start,end){ if(!start||!end) return ''; const [sh,sm]=start.split(':').map(Number); const [eh,em]=end.split(':').map(Number); let s=sh*60+sm,e=eh*60+em; if(e<s)e+=1440; return e-s; }
  function hhmmFromMin(m){m=((m%1440)+1440)%1440; const H=('0'+Math.floor(m/60)).slice(-2), M=('0'+(m%60)).slice(-2); return H+':'+M;}

  // state
  const state={logs:load(), act:'study', lastAddedId:null, sets:[]};

  // init date and sliders
  $('#date').value=todayStr();
  $('#sleep_start_date').value=todayStr();
  $('#sleep_end_date').value=todayStr();
  const startSlider=$('#start_slider'), endSlider=$('#end_slider');
  startSlider.value=540; endSlider.value=600; // 09:00~10:00 default
  $('#start_label').textContent=hhmmFromMin(Number(startSlider.value));
  $('#end_label').textContent=hhmmFromMin(Number(endSlider.value));

  // rating seg build
  const seg=$('#rating_seg'); for(let i=1;i<=10;i++){ const b=document.createElement('div'); b.className='seg'+(i==7?' active':''); b.textContent=i; b.dataset.val=i;
    b.addEventListener('click',()=>{ $('#rating').value=i; $$('#rating_seg .seg').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }); seg.appendChild(b);
  }
  $('#rating').value=7;

  // tabs
  $$('.tab-btn').forEach(btn=>btn.addEventListener('click',()=>{
    $$('.tab-btn').forEach(x=>x.classList.remove('active')); 
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    $$('section[data-section]').forEach(s=>s.style.display='none');
    const target = $(`section[data-section="${tab}"]`);
    if(target) target.style.display='';
    if(tab==='history') renderHistory();
  }));

  // activity buttons
  $$('#actbar .actbtn').forEach(btn=>btn.addEventListener('click',()=>{
    $$('#actbar .actbtn').forEach(x=>x.classList.remove('active')); btn.classList.add('active');
    state.act=btn.dataset.act;
    const act=state.act;
    $('#rating_label').textContent=ratingLabel(act);
    const showMemo = (act==='memo');
    const isSleep = (act==='sleep');
    const isStudy = (act==='study');
    const isExercise = (act==='exercise');
    $('#time_wrap').style.display = showMemo ? 'none' : '';
    $('#rating_wrap').style.display = showMemo ? 'none' : '';
    $('#study_extra').style.display = isStudy ? '' : 'none';
    $('#sleep_extra').style.display = isSleep ? '' : 'none';
    $('#ex_builder').style.display = isExercise ? '' : 'none';

    if(isSleep){
      $('#normal_date_row').style.display = 'none';
      $('#sleep_date_row').style.display = '';
      $('#sleep_subtype_row').style.display = '';
      const today = todayStr();
      if(!$('#sleep_start_date').value) $('#sleep_start_date').value = today;
      if(!$('#sleep_end_date').value) $('#sleep_end_date').value = today;
    } else {
      $('#normal_date_row').style.display = '';
      $('#sleep_date_row').style.display = 'none';
      $('#sleep_subtype_row').style.display = 'none';
    }
  }));

  // time sliders
  startSlider.addEventListener('input',()=>{ $('#start_label').textContent=hhmmFromMin(Number(startSlider.value)); });
  endSlider.addEventListener('input',()=>{ $('#end_label').textContent=hhmmFromMin(Number(endSlider.value)); });

  // reset
  $('#reset_form_btn').addEventListener('click',()=>{
    $('#date').value=todayStr();
    $('#sleep_start_date').value=todayStr();
    $('#sleep_end_date').value=todayStr();
    startSlider.value=540; endSlider.value=600;
    $('#start_label').textContent='09:00'; $('#end_label').textContent='10:00';
    $('#sub_type').value=''; $('#sleep_sub_type').value=''; $('#note').value=''; $('#weight').value=''; $('#motivation').value='';
    $('#recall_score_pct').value=''; $('#distraction_count').value='';
    $('#sleep_latency_min').value=''; $('#last_caffeine_time').value=''; $('#screens_off_time').value='';
    $('#morning_weight_kg').value=''; $('#protein_g_day').value=''; $('#creatine_5g').checked=false; $('#days_to_exam').value='';
    $('#rating').value=7; $$('#rating_seg .seg').forEach(x=>x.classList.toggle('active', Number(x.dataset.val)===7));
    state.act='study'; $$('#actbar .actbtn').forEach(x=>x.classList.toggle('active', x.dataset.act==='study'));
    $('#time_wrap').style.display=''; $('#rating_wrap').style.display='';
    $('#normal_date_row').style.display=''; $('#sleep_date_row').style.display='none'; $('#sleep_subtype_row').style.display='none';
    state.sets=[]; renderSets();
    showSnack('ì…ë ¥ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.',1200);
  });

  // snackbar
  function showSnack(html,timeout=2000){ const s=$('#snack'); s.innerHTML=html; s.classList.add('show'); setTimeout(()=>s.classList.remove('show'),timeout); }

  // exercise builder logic
  function renderSets(){
    const list=$('#set_list'); list.innerHTML='';
    if(!state.sets.length){ list.innerHTML='<div class="help">ì„¸íŠ¸ë¥¼ ì¶”ê°€í•˜ë©´ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</div>'; $('#ex_summary').textContent=''; return; }
    state.sets.forEach((st,i)=>{
      const row=document.createElement('div'); row.className='flex';
      row.innerHTML=`<span class="pill setbadge">#${i+1}</span><span>${st.weight}kg Ã— ${st.reps} reps</span><span class="help">RPE ${st.rpe??'-'}</span><button class="danger" data-del-index="${i}">ì‚­ì œ</button>`;
      list.appendChild(row);
    });
    $$('#set_list [data-del-index]').forEach(btn=>btn.addEventListener('click',()=>{
      const idx=Number(btn.getAttribute('data-del-index')); state.sets.splice(idx,1); renderSets();
    }));
    const volume = state.sets.reduce((a,b)=>a+(Number(b.weight)||0)*(Number(b.reps)||0),0);
    // top set by weight*reps heuristic
    let top=null, topScore=-1; state.sets.forEach(s=>{const sc=(Number(s.weight)||0)*(Number(s.reps)||0); if(sc>topScore){topScore=sc; top=s;}});
    const mv=$('#ex_movement').value||'ìš´ë™';
    $('#ex_summary').textContent = `${mv}: ${state.sets.length}ì„¸íŠ¸ Â· ì´ë³¼ë¥¨ ${volume}kgÂ·reps${top?` Â· Top ${top.weight}kgÃ—${top.reps}`:''}`;
  }

  $('#add_set_btn').addEventListener('click',()=>{
    const w=Number($('#ex_weight').value); const r=Number($('#ex_reps').value); const p=$('#ex_rpe').value? Number($('#ex_rpe').value):null;
    if(!(w>0&&r>0)) return showSnack('ì¤‘ëŸ‰ê³¼ ë°˜ë³µì„ ì…ë ¥í•˜ì„¸ìš”.');
    state.sets.push({weight:w,reps:r,rpe:p});
    $('#ex_weight').value=''; $('#ex_reps').value=''; $('#ex_rpe').value='';
    renderSets();
  });
  $('#clear_sets_btn').addEventListener('click',()=>{ state.sets=[]; renderSets(); });

  // save (main)
  function getRow(){
    const act=state.act;
    let date, subType;
    if(act === 'sleep') { date = $('#sleep_start_date').value || todayStr(); subType = ($('#sleep_sub_type').value||'').trim(); }
    else { date = $('#date').value || todayStr(); subType = ($('#sub_type').value||'').trim(); }

    let start='', end='', rating='';
    if (act!=='memo'){
      start = hhmmFromMin(Number($('#start_slider').value));
      end = hhmmFromMin(Number($('#end_slider').value));
      rating = Number($('#rating').value||0) || '';
    }

    const row={
      id:Date.now(), date, start_time:start, end_time:end, activity:act, sub_type:subType,
      rating_name:ratingLabel(act), rating: rating,
      weight_kg: $('#weight').value ? Number($('#weight').value) : '',
      motivation: $('#motivation').value ? Number($('#motivation').value) : '',
      note: ($('#note').value||'').trim(),
      morning_weight_kg:'', protein_g_day:'', creatine_5g:'', last_caffeine_time:'', screens_off_time:'', sleep_latency_min:'', recall_score_pct:'', distraction_count:'', days_to_exam:'', exercise_json:''
    };

    // ìˆ˜ë©´ í™•ì¥ í•„ë“œ
    if(act==='sleep'){
      row.sleep_end_date = $('#sleep_end_date').value || date;
      row.sleep_latency_min = $('#sleep_latency_min').value? Number($('#sleep_latency_min').value):'';
      row.last_caffeine_time = $('#last_caffeine_time').value || '';
      row.screens_off_time = $('#screens_off_time').value || '';
    }

    // ê³µë¶€ í™•ì¥ í•„ë“œ
    if(act==='study'){
      row.recall_score_pct = $('#recall_score_pct').value? Number($('#recall_score_pct').value):'';
      row.distraction_count = $('#distraction_count').value? Number($('#distraction_count').value):'';
    }

    // ìš´ë™ ì„¸íŠ¸ JSON
    if(act==='exercise' && state.sets.length){
      const mv=$('#ex_movement').value||''; const note=$('#ex_note').value||'';
      const volume = state.sets.reduce((a,b)=>a+(Number(b.weight)||0)*(Number(b.reps)||0),0);
      let top=null, topScore=-1; state.sets.forEach(s=>{const sc=(Number(s.weight)||0)*(Number(s.reps)||0); if(sc>topScore){topScore=sc; top=s;}});
      const payload={movement:mv, note, sets:state.sets, total_volume:volume, top_set:top};
      row.exercise_json = JSON.stringify(payload);
      // ì„¸ë¶€ í‘œì‹œ ë³´ì¡°ë¡œ sub_type ë¹„ì›Œì ¸ ìˆìœ¼ë©´ ìš´ë™ëª… ì±„ìš°ê¸°
      if(!row.sub_type && mv) row.sub_type = mv;
    }

    row.duration_min = (act!=='memo') ? durationMin(row.start_time,row.end_time) : '';
    return row;
  }

  function isOverlap(row){
    if (!row.start_time || !row.end_time) return false;
    const sameDay=state.logs.filter(r=>r.date===row.date && r.activity!=='memo');
    const sMin=x=>{const [h,m]=x.split(':').map(Number);return h*60+m;};
    const inRange=(a,b,x)=>(x>=a && x<b);
    const x=sMin(row.start_time), y=sMin(row.end_time);
    for(const r of sameDay){
      if(!r.start_time||!r.end_time)continue;
      const a=sMin(r.start_time), b=sMin(r.end_time);
      if (inRange(a,b,x) || inRange(a,b,y) || inRange(x,y,a) || inRange(x,y,b)) return true;
    }
    return false;
  }

  function saveRow(row){
    state.logs.push(row); save(state.logs); state.lastAddedId=row.id;
    showSnack('ì €ì¥ë¨ Â· <a id="undo_link" href="#">â†º ë˜ëŒë¦¬ê¸°</a>');
    setTimeout(()=>{const u=$('#undo_link'); if(u){u.addEventListener('click',e=>{e.preventDefault(); undoLast();});}},50);
    renderHistory();
    // ìš´ë™ ì„¸íŠ¸ëŠ” ì €ì¥ í›„ ì´ˆê¸°í™”
    if(row.activity==='exercise'){ state.sets=[]; renderSets(); }
  }

  function undoLast(){
    if(!state.lastAddedId) return;
    state.logs = state.logs.filter(x=>x.id!==state.lastAddedId);
    save(state.logs); state.lastAddedId=null;
    showSnack('ë˜ëŒë ¸ìŠµë‹ˆë‹¤.',1200);
    renderHistory();
  }

  $('#save_btn').addEventListener('click',()=>{
    const row=getRow();
    if(!row.date) return showSnack('ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    if(state.act!=='memo'){
      if(!row.start_time||!row.end_time) return showSnack('ì‹œì‘/ë ì‹œê°ì„ ì„¤ì •í•˜ì„¸ìš”.');
      if(!row.rating) return showSnack('í‰ì •(1â€“10)ì„ ì„ íƒí•˜ì„¸ìš”.');
      if(isOverlap(row) && !confirm('ê²¹ì¹˜ëŠ” ì‹œê°„ì´ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì €ì¥í• ê¹Œìš”?')) return;
    }
    saveRow(row);
  });

  // âœ… ì¼ì¼ ì§€í‘œ ë¹ ë¥¸ ì €ì¥ (memo í–‰ìœ¼ë¡œ ì €ì¥)
  $('#daily_save_btn').addEventListener('click',()=>{
    const date = $('#date').value || todayStr();
    const mkg = $('#morning_weight_kg').value? Number($('#morning_weight_kg').value):'';
    const pgd = $('#protein_g_day').value? Number($('#protein_g_day').value):'';
    const crt = $('#creatine_5g').checked? 'Y' : 'N';
    const dte = $('#days_to_exam').value? Number($('#days_to_exam').value):'';
    if(mkg==='' && pgd==='' && crt==='N' && dte==='') return showSnack('ì…ë ¥ëœ ì¼ì¼ ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
    const row={ id:Date.now(), date, start_time:'', end_time:'', activity:'memo', sub_type:'daily', rating_name:'ë©”ëª¨', rating:'', weight_kg:'', motivation:'', note:'', duration_min:'', sleep_end_date:'',
      morning_weight_kg:mkg, protein_g_day:pgd, creatine_5g:crt, last_caffeine_time:'', screens_off_time:'', sleep_latency_min:'', recall_score_pct:'', distraction_count:'', days_to_exam:dte, exercise_json:'' };
    saveRow(row);
  });

  // history
  function renderHistory(){
    const tbody=$('#history_table tbody'); tbody.innerHTML='';
    const q=($('#search_text').value||'').toLowerCase();
    const act=$('#filter_activity').value; const from=$('#hist_from').value; const to=$('#hist_to').value;
    const filtered=state.logs.filter(r=>{
      const inAct=act? r.activity===act : true;
      const inText=q ? (String(r.note||'').toLowerCase().includes(q) || String(r.sub_type||'').toLowerCase().includes(q)) : true;
      const inRange=withinRange(r.date,from,to);
      return inAct && inText && inRange;
    }).sort((a,b)=>(a.date+(a.start_time||'')).localeCompare(b.date+(b.start_time||'')));

    filtered.forEach(r=>{
      const tr=document.createElement('tr');
      let dateDisplay = r.date;
      if(r.activity === 'sleep' && r.sleep_end_date && r.sleep_end_date !== r.date) { dateDisplay = r.date + '~' + r.sleep_end_date; }

      // meta chips
      const chips=[];
      if(r.activity==='study'){
        if(r.recall_score_pct!=='' && r.recall_score_pct!=null) chips.push(`<span class="pill">íšŒìƒ ${r.recall_score_pct}%</span>`);
        if(r.distraction_count!=='' && r.distraction_count!=null) chips.push(`<span class="pill">ë°©í•´ ${r.distraction_count}</span>`);
      }
      if(r.activity==='sleep'){
        if(r.sleep_latency_min!=='') chips.push(`<span class="pill">ì…ë©´ ${r.sleep_latency_min}ë¶„</span>`);
        if(r.last_caffeine_time) chips.push(`<span class="pill">ì¹´í˜ì¸ ${r.last_caffeine_time}</span>`);
        if(r.screens_off_time) chips.push(`<span class="pill">ìŠ¤í¬ë¦° ${r.screens_off_time}</span>`);
      }
      // memo(daily)
      if(r.activity==='memo'){
        if(r.sub_type==='daily'){
          if(r.morning_weight_kg!=='') chips.push(`<span class="pill">ì•„ì¹¨ ${r.morning_weight_kg}kg</span>`);
          if(r.protein_g_day!=='') chips.push(`<span class="pill">ë‹¨ë°±ì§ˆ ${r.protein_g_day}g</span>`);
          if(r.creatine_5g) chips.push(`<span class="pill">í¬ë ˆì•„í‹´ ${r.creatine_5g}</span>`);
          if(r.days_to_exam!=='') chips.push(`<span class="pill">D-${r.days_to_exam}</span>`);
        }
      }
      // exercise summary
      if(r.activity==='exercise' && r.exercise_json){
        try{ const ex=JSON.parse(r.exercise_json); if(ex){
          const vol = ex.total_volume||0; const count=(ex.sets||[]).length; const mv=ex.movement||'ìš´ë™';
          chips.push(`<span class=\"pill\">${mv} ${count}ì„¸íŠ¸ Â· ${vol}kgÂ·reps</span>`);
          if(ex.top_set) chips.push(`<span class=\"pill\">Top ${ex.top_set.weight}kgÃ—${ex.top_set.reps}</span>`);
        }}catch(e){}
      }

      tr.innerHTML=`
        <td>${dateDisplay}</td>
        <td>${r.activity==='memo' ? '-' : (r.start_time||'')+'â€“'+(r.end_time||'')}<div class="help">${r.duration_min? r.duration_min+'ë¶„':''}</div></td>
        <td><span class="pill">${activityName(r.activity)}</span></td>
        <td>${r.activity==='memo' ? '-' : (r.rating_name+' '+(r.rating??''))}</td>
        <td>${r.weight_kg??''}</td>
        <td>${r.motivation??''}</td>
        <td>${r.sub_type? '<span class="pill">'+r.sub_type+'</span>' : ''}${chips.length? '<div class="mt8">'+chips.join('')+'</div>':''}</td>
        <td>${r.note||''}</td>
        <td class="right"><button class="danger" data-del="${r.id}">ì‚­ì œ</button></td>`;
      tbody.appendChild(tr);
    });
    $$('button[data-del]').forEach(btn=>btn.addEventListener('click',()=>{
      const id=Number(btn.getAttribute('data-del'));
      state.logs=state.logs.filter(x=>x.id!==id); save(state.logs); renderHistory();
    }));
  }
  $('#search_text').addEventListener('input',renderHistory);
  $('#filter_activity').addEventListener('change',renderHistory);
  $('#hist_from').addEventListener('change',renderHistory);
  $('#hist_to').addEventListener('change',renderHistory);

  // export CSV
  $('#export_btn').addEventListener('click',()=>{
    const from=$('#export_from').value; const to=$('#export_to').value;
    const rows=state.logs.filter(r=>withinRange(r.date,from,to)).sort((a,b)=>(a.date+(a.start_time||'')).localeCompare(b.date+(b.start_time||'')));
    if(!rows.length){showSnack('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}
    const csv='\uFEFF'+toCSV(rows); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`mylife_${(from||'start').replaceAll('-','')}-${(to||'end').replaceAll('-','')}.csv`; document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 1000);
    showSnack('CSV ì €ì¥ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.',1500);
  });

  // presets
  function setPreset(which){
    const now=new Date(); const dow=(now.getDay()+6)%7; let from,to;
    if(which==='thisweek'){const monday=new Date(now); monday.setDate(now.getDate()-dow); const sunday=new Date(monday); sunday.setDate(monday.getDate()+6); from=monday; to=sunday;}
    else if(which==='lastweek'){const monday=new Date(now); monday.setDate(now.getDate()-dow-7); const sunday=new Date(monday); sunday.setDate(monday.getDate()+6); from=monday; to=sunday;}
    else if(which==='thismonth'){const first=new Date(now.getFullYear(), now.getMonth(), 1); const last=new Date(now.getFullYear(), now.getMonth()+1, 0); from=first; to=last;}
    $('#export_from').value=from.toISOString().slice(0,10);
    $('#export_to').value=to.toISOString().slice(0,10);
    $('#hist_from').value=$('#export_from').value;
    $('#hist_to').value=$('#export_to').value;
    renderHistory(); showSnack('ê¸°ê°„ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
  $$('[data-preset]').forEach(el=>el.addEventListener('click',()=>setPreset(el.dataset.preset)));

  // backup/restore
  $('#backup_json_btn').addEventListener('click',()=>{
    const blob=new Blob([JSON.stringify(state.logs,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`mylife_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 1000); showSnack('JSON ë°±ì—…ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
  });
  $('#restore_json_input').addEventListener('change',e=>{
    const file=e.target.files[0]; if(!file)return;
    const reader=new FileReader(); reader.onload=()=>{
      try{const arr=JSON.parse(reader.result); if(!Array.isArray(arr)) throw new Error('í˜•ì‹ ì˜¤ë¥˜');
        const byId=new Map(state.logs.map(x=>[x.id,x])); arr.forEach(x=>{ if(x && x.id && !byId.has(x.id)) byId.set(x.id,x); });
        state.logs=Array.from(byId.values()); save(state.logs); renderHistory(); showSnack('JSON ë³µì›ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      }catch(err){showSnack('JSON íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');}
      e.target.value='';
    }; reader.readAsText(file);
  });

  // initial render
  renderHistory();
})();</script>
</body>
</html>
